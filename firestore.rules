rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function userRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    function isAdmin() {
      return request.auth != null && (userRole() == 'Admin' || userRole() == 'admin');
    }
    function isInstructor() {
      return request.auth != null && (userRole() == 'Instructor' || userRole() == 'instructor');
    }

    // ===== Production-safe rules =====
    // Users collection: 
    // - Users can read/write their own document
    // - Instructors and Admins can read any user's name field (for attribution display)
    match /users/{userId} {
      allow read: if request.auth != null && (
        request.auth.uid == userId || isInstructor() || isAdmin()
      );
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Feedbacks require authentication
    match /feedbacks/{feedbackId} {
      allow read, write: if request.auth != null;
    }

    // Instructor course selection feedbacks - suitable candidates
    match /instructor_course_selection_suitable/{docId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.instructorId;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.instructorId;
    }

    // Instructor course selection feedbacks - not suitable candidates
    match /instructor_course_selection_not_suitable/{docId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.instructorId;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.instructorId;
    }

    // ===== INSTRUCTOR COURSE SCREENING COLLECTIONS =====
    // DRAFTS collection (in-progress/temporary feedbacks)
    match /instructor_course_drafts/{draftId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner() {
        return request.auth != null && resource.data.createdBy == request.auth.uid;
      }
      function isOwnerCreate() {
        return request.auth != null && request.resource.data.createdBy == request.auth.uid;
      }

      // Allow create for any signed-in user
      allow create: if isSignedIn();

      // Allow read for owner or admin
      allow read: if isOwner() || isAdmin();

      // Allow update for owner when status is draft
      allow update: if (isOwner() || isAdmin()) && (
        resource.data.status == 'draft' || resource.data.status == 'in_progress'
      );

      // Allow delete for owner or admin (needed for finalize operation)
      allow delete: if isOwner() || isAdmin();
    }

    // FINALS collection (finalized instructor course feedbacks)
    match /instructor_course_feedbacks/{feedbackId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwnerCreate() {
        return request.auth != null && request.resource.data.createdBy == request.auth.uid;
      }
      function isOwner() {
        return request.auth != null && resource.data.createdBy == request.auth.uid;
      }

      // Allow create for any signed-in instructor/admin
      allow create: if isSignedIn();

      // Allow read for any authenticated user
      allow read: if request.auth != null;

      // Allow update for owner or admin only
      allow update: if isOwner() || isAdmin();

      // Prevent deletion of final feedbacks
      allow delete: if isAdmin();
    }

    // Candidate aggregate docs (if used)
    match /instructor_course_candidates/{candidateId} {
      allow read: if isAdmin() || isInstructor();
      // Admin can write freely
      allow write: if isAdmin();
    }

    // ===== INSTRUCTOR COURSE EVALUATIONS (SINGLE COLLECTION) =====
    // Unified collection for drafts and finals with status field
    // Used by miunim (instructor course selection) module
    // ✅ ALL instructors/admins can see ALL final submissions (shared visibility)
    // ✅ ALL instructors/admins can see and edit ALL drafts (shared collaboration)
    match /instructor_course_evaluations/{evalId} {
      // Allow create for any instructor/admin
      allow create: if request.auth != null && (isInstructor() || isAdmin());

      // ✅ Allow read for all instructors/admins (both drafts and finals)
      allow read: if request.auth != null && (isInstructor() || isAdmin());

      // ✅ Allow update for all instructors/admins (both drafts and finals)
      allow update: if request.auth != null && (isInstructor() || isAdmin());

      // Allow delete ONLY for admin
      allow delete: if isAdmin();
    }

    // ===== SETTLEMENT TRAINEES COLLECTION =====
    // רשימות חניכים לפי יישוב - להשלמה אוטומטית בטפסים
    // ✅ All instructors/admins can read (for autocomplete in forms)
    // ✅ Only admin can write (data is uploaded once)
    match /settlement_trainees/{settlementId} {
      allow read: if request.auth != null && (isInstructor() || isAdmin());
      allow write: if isAdmin();
    }

    // ===== CUSTOM SETTLEMENTS COLLECTION =====
    // יישובים מותאמים אישית שהמשתמשים מוסיפים
    match /custom_settlements/{docId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if isAdmin();
    }

    // Nested screenings under courses/{courseId}/screenings/{screeningId}
    match /courses/{courseId}/screenings/{screeningId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner() {
        return request.auth != null && resource.data.instructorId == request.auth.uid;
      }

      // Allow create for any signed-in user; do not require fields at create time
      allow create: if isSignedIn();

      // Read/update for owner; Admin can read/update all
      allow read: if isOwner() || isAdmin();
      allow update: if (isOwner() || isAdmin());

      // No deletes
      allow delete: if false;
    }

    // Block everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}