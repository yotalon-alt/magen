# Quick Test Guide: Instructor Course Atomic Finalize

**Goal**: Verify atomic batch operation works correctly

---

## ğŸ¯ What We Fixed

âœ… **Atomic Operation**: Finalize now uses WriteBatch (create final + delete temp in ONE transaction)  
âœ… **Collection Queries**: Lists and exports now query correct collection with filters  
âœ… **State Management**: Form locks after finalize, exit dialog respects save state

---

## ğŸš€ Quick Test Steps

### Test 1: Happy Path (Complete Flow)
1. **Navigate**: ××™×•× ×™× ×œ×§×•×¨×¡ ××“×¨×™×›×™× â†’ ××™×•× ×™× â€“ ×›×œ×œ×™ â†’ ×§×•×¨×¡ ××“×¨×™×›×™×
2. **Create**: Fill required details (command, brigade, name, number)
3. **Save Temp**: Click "Save Progress" â†’ Should see "× ×©××¨ ×›××©×•×‘ ×‘×ª×”×œ×™×š"
4. **Complete**: Fill all rubrics (9 categories + level test)
5. **Finalize**: Click "Finish Feedback"
6. **Verify Console**:
   ```
   âœ… BATCH: Commit successful!
   RESULT: Final doc created: <id>
   RESULT: Temp doc deleted: <id>
   ```
7. **Verify Firestore**:
   - `instructor_course_feedbacks`: New doc with `status='finalized'`
   - `instructor_course_screenings`: Original temp doc DELETED
8. **Check List**: Navigate back â†’ Click suitable/not suitable â†’ Should appear in correct list

### Test 2: List Filtering
1. **Navigate**: ××™×•× ×™× ×œ×§×•×¨×¡ ××“×¨×™×›×™× â†’ ××ª××™××™× ×œ×§×•×¨×¡ ××“×¨×™×›×™×
2. **Verify Console**:
   ```
   QUERY: collection=instructor_course_feedbacks
   QUERY: where("isSuitable", "==", true)
   RESULT: Got X documents
   ```
3. **Verify UI**: Shows only suitable candidates (weighted score â‰¥ 70)
4. **Repeat**: Test "×œ× ××ª××™××™×" list (should show score < 70)

### Test 3: Export
1. **From List**: Click export button (download icon)
2. **Select Category**: Choose suitable/not suitable/both
3. **Verify**: XLSX file downloads with correct filtered data
4. **Console Log**: Should show query to `instructor_course_feedbacks`

---

## ğŸ” Expected Console Output

### Successful Finalize
```
========== ATOMIC BATCH: INSTRUCTOR COURSE ==========
BATCH: Creating WriteBatch for atomic operation
BATCH: SET final doc in instructor_course_feedbacks
BATCH: finalDocId=<auto-generated>
BATCH: DELETE temp doc from instructor_course_screenings
BATCH: tempDocId=<original-temp-id>
BATCH: Committing batch (atomic operation)...
âœ… BATCH: Commit successful!
RESULT: Final doc created: <id>
RESULT: Temp doc deleted: <id>
RESULT: module=instructor_course_selection
RESULT: type=instructor_course_feedback
RESULT: isTemporary=false
RESULT: status=finalized
=====================================================
```

### Successful List Load
```
ğŸ” ===== LOADING INSTRUCTOR COURSE FEEDBACKS =====
QUERY: collection=instructor_course_feedbacks
QUERY: where("isSuitable", "==", true)
QUERY: where("status", "==", "finalized")
QUERY: orderBy("createdAt", descending: true)
RESULT: Got 3 documents
DOC: abc123 - John Doe (suitable=true)
DOC: def456 - Jane Smith (suitable=true)
DOC: ghi789 - Bob Jones (suitable=true)
===================================================
```

---

## âš ï¸ Common Issues & Solutions

### Issue: "×œ× × ×™×ª×Ÿ ×œ×¡×™×™× ×œ×œ× ××–×”×” ××©×•×‘"
**Cause**: `_existingScreeningId` is null  
**Solution**: Must click "Save Progress" at least once before finalizing

### Issue: "×™×© ×œ×”×©×œ×™× ××ª ×›×œ ×”×¨×•×‘×¨×™×§×•×ª"
**Cause**: Not all 9 categories filled  
**Solution**: Ensure all rubrics have score > 0 (except level test which is optional)

### Issue: List shows empty
**Cause**: No finalized feedbacks exist OR query filter mismatch  
**Solution**: 
1. Check Firestore console - do docs have `status='finalized'`?
2. Check console logs - what does query return?
3. Create test feedback and finalize it

### Issue: Feedback appears in both suitable AND not suitable
**Cause**: Should be impossible with new code!  
**Solution**: If this happens, document is corrupted - check Firestore console for `isSuitable` field

---

## ğŸ“Š Firestore Verification Checklist

After successful finalize, check Firebase Console:

### `instructor_course_feedbacks` Collection
```json
{
  "id": "abc123xyz",
  "status": "finalized",
  "isSuitable": true,  // â† KEY: Should match weighted score
  "finalWeightedScore": 85.5,
  "candidateName": "John Doe",
  "command": "×¦×¤×•×Ÿ",
  "brigade": "474",
  "candidateNumber": 12345,
  "module": "instructor_course_selection",
  "type": "instructor_course_feedback",
  "isTemporary": false,
  "finalizedAt": "2026-01-03T10:30:00Z",
  "createdAt": "2026-01-03T10:30:00Z",
  "createdBy": "<uid>",
  "fields": {
    "×›×•×©×¨ ×’×•×¤× ×™": {"value": 5, "filledBy": "...", "filledAt": "..."},
    // ... other fields
  }
}
```

### `instructor_course_screenings` Collection
- **Original temp doc**: Should be DELETED (not exist anymore)
- **Other drafts**: Should remain untouched

---

## âœ… Success Criteria

You know it's working when:

1. âœ… Console shows "BATCH: Commit successful!"
2. âœ… Temp doc deleted from `instructor_course_screenings`
3. âœ… Final doc created in `instructor_course_feedbacks`
4. âœ… Final doc has `status='finalized'`, `isTemporary=false`
5. âœ… Final doc has correct `isSuitable` based on score
6. âœ… Feedback appears in correct list (suitable or not suitable)
7. âœ… Exit dialog does NOT appear after successful finalize
8. âœ… Form is locked (all inputs disabled) after finalize
9. âœ… Export includes the finalized feedback

---

## ğŸ› If Something Goes Wrong

### Check Console Logs
Look for error messages starting with:
- `âŒ Finalize error:`
- `âŒ BATCH FAILED:`

### Check Firestore Console
1. Go to Firebase Console â†’ Firestore Database
2. Check both collections:
   - `instructor_course_screenings` (temp)
   - `instructor_course_feedbacks` (final)
3. Verify document fields match expected structure above

### Check Network Tab (Browser DevTools)
1. Open browser DevTools (F12)
2. Go to Network tab
3. Filter: `firestore`
4. Look for batch commit request
5. Check response status (should be 200 OK)

---

## ğŸ“ Reporting Issues

If you find a bug, report:

1. **What you did**: Step-by-step actions
2. **What happened**: Actual behavior
3. **What you expected**: Expected behavior
4. **Console logs**: Copy full console output
5. **Firestore state**: Screenshot of both collections
6. **Document IDs**: Include temp and final doc IDs

---

## ğŸ“ Understanding the Fix

**Before**: Sequential operations (create final, then delete temp) could fail partially.

**After**: Atomic batch operation guarantees BOTH operations succeed or BOTH fail together.

**Why it matters**: Prevents feedback from existing in both collections or getting "stuck" in temp collection.

**How to verify**: Check console logs for "BATCH: Commit successful!" and verify Firestore state manually.

---

**Last Updated**: 2026-01-03  
**Status**: Ready for testing  
**Files Modified**: 3 (instructor_course_feedback_page.dart, instructor_course_selection_feedbacks_page.dart, feedback_export_service.dart)
